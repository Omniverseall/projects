<!DOCTYPE html>
<html>

<head>
    <title>Map</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f9;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            width: 100%;
            box-sizing: border-box;
        }

        .search-container label {
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .search-container input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .search-container input:focus {
            border-color: #0078d4;
            outline: none;
        }

        .search-container button {
            width: 100%;
            padding: 10px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .search-container button:hover {
            background: #005bb5;
        }

        .search-container button i {
            margin-right: 8px;
        }

        .suggestions-container {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: calc(100% - 30px);
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1001;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .leaflet-popup-content {
            font-size: 14px;
            color: #333;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .leaflet-popup-tip {
            background: white;
        }
    </style>
</head>

<body>
    <div class="search-container">
        <label for="start"><i class="fas fa-map-marker-alt"></i> Начало маршрута:</label>
        <input type="text" id="start" placeholder="Введите начальную точку" autocomplete="off" />
        <div id="start-suggestions" class="suggestions-container" style="display: none;"></div>

        <label for="end"><i class="fas fa-flag-checkered"></i> Конец маршрута:</label>
        <input type="text" id="end" placeholder="Введите конечную точку" autocomplete="off" />
        <div id="end-suggestions" class="suggestions-container" style="display: none;"></div>

        <button onclick="calculateRoute()"><i class="fas fa-route"></i> Построить маршрут</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/polyline-encoded@0.0.9/Polyline.encoded.js"></script>
    <script>
        let map = L.map('map').setView([41.0, 69.5], 8);
        L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=vTRt3PHodyeuzWbTzEzD', {
            attribution: '© <a href="https://www.maptiler.com/">MapTiler</a>'
        }).addTo(map);

        let startMarker, endMarker, routePolyline;
        let selectedStart = null;
        let selectedEnd = null;

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                var later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function searchLocations(query) {
            if (!query) return [];
            try {
                var response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`);
                var data = await response.json();
                return data.features || [];
            } catch (error) {
                console.error('Ошибка поиска:', error);
                return [];
            }
        }

        function formatAddress(properties) {
            var parts = [];
            if (properties.name) parts.push(properties.name);
            if (properties.street) parts.push(properties.street);
            if (properties.city) parts.push(properties.city);
            if (properties.state) parts.push(properties.state);
            if (properties.country) parts.push(properties.country);
            return parts.join(', ');
        }

        function setupAutocomplete(inputId, suggestionsId, onSelect) {
            var input = document.getElementById(inputId);
            var suggestionsContainer = document.getElementById(suggestionsId);

            var updateSuggestions = debounce(async (value) => {
                var features = await searchLocations(value);
                suggestionsContainer.innerHTML = '';
                
                if (features.length > 0) {
                    features.forEach(feature => {
                        var div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = formatAddress(feature.properties);
                        div.addEventListener('click', () => {
                            input.value = formatAddress(feature.properties);
                            onSelect(feature);
                            suggestionsContainer.style.display = 'none';
                        });
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            }, 300);

            input.addEventListener('input', (e) => {
                updateSuggestions(e.target.value);
            });

            input.addEventListener('focus', () => {
                if (suggestionsContainer.children.length > 0) {
                    suggestionsContainer.style.display = 'block';
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        setupAutocomplete('start', 'start-suggestions', (feature) => {
            selectedStart = feature;
        });

        setupAutocomplete('end', 'end-suggestions', (feature) => {
            selectedEnd = feature;
        });

        function calculateRoute() {
            if (!selectedStart || !selectedEnd) {
                alert('Пожалуйста, выберите начальную и конечную точки из списка предложений!');
                return;
            }

            var startCoords = [selectedStart.geometry.coordinates[1], selectedStart.geometry.coordinates[0]];
            var endCoords = [selectedEnd.geometry.coordinates[1], selectedEnd.geometry.coordinates[0]];

            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routePolyline) map.removeLayer(routePolyline);

            startMarker = L.marker(startCoords, { icon: greenIcon }).addTo(map)
                .bindPopup('Начало маршрута: ' + formatAddress(selectedStart.properties));
            endMarker = L.marker(endCoords, { icon: redIcon }).addTo(map)
                .bindPopup('Конец маршрута: ' + formatAddress(selectedEnd.properties));

            var url = `http://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'Ok') {
                        var route = data.routes[0].geometry;
                        var decodedRoute = L.Polyline.fromEncoded(route).getLatLngs();
                        routePolyline = L.polyline(decodedRoute, { color: '#0078d4', weight: 5 }).addTo(map);

                        var distance = (data.routes[0].distance / 1000).toFixed(2);
                        var duration = (data.routes[0].duration / 60).toFixed(2);
                        L.popup()
                            .setLatLng(startCoords)
                            .setContent(`<b>Расстояние:</b> ${distance} км<br><b>Время:</b> ${duration} мин`)
                            .openOn(map);

                        // Подгоняем карту под маршрут
                        map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
                    } else {
                        alert('Не удалось построить маршрут. Попробуйте другие точки.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка запроса:', error);
                    alert('Произошла ошибка при построении маршрута.');
                });
        }

        var greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        var redIcon = L.icon({
            iconUrl: './free-icon-flag-5522849.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 30],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
    </script>
</body>

</html>